---
title: 静态博客—Hexo
date: 2025-06-01 10:34:58
updated: 2025-10-08 14:40:26
categories:
  - [服务器&嵌入式平台操作, 工具]
tags:
permalink: 静态博客—hexo/
---

### 环境准备与Hexo安装

$Last Edited：2025.04.28/20:41$
___

直接从apt下载，版本可能比较低，用这个方法可以选择合适的版本。
**添加 NodeSource 的 Node.js 20.x 仓库**（你可以选择其他支持的版本，如 18.x 或 20.x）：
```bash
 curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
```

安装 **Node.js** 和 **npm**：
```bash
sudo apt-get install -y nodejs
```

验证：
```bash
node -v
npm -v
```

使用 **npm** 全局安装 **Hexo**：
```bash
sudo npm install -g hexo-cli
```

安装完成后，检查 **Hexo** 版本：
```bash
hexo -v
```

 创建 **Hexo** 博客
选择一个目录存放博客文件，例如 `/home/yourname/blog`，然后运行以下命令初始化 Hexo：
```bash
hexo init /home/yourname/blog
cd /home/yourname/blog
npm install
```

在目录下，生成静态文件并启动本地服务器：
```bash
hexo generate
hexo server
```
默认在`http://localhost:4000`运行。

### Hexo部署到GitHub
参考：
[Ubuntu:Hexo+github搭建个人博客 | Akilarの糖果屋](https://akilar.top/posts/e5502ef6/)

$Last Edited：2025.04.28/20:41$
___

- [x] GitHub Pages 仓库命名规则：
    - **用户/组织站点**：仓库名 **必须** 为 `<username>.github.io`（例如 `cloak1522.github.io`），访问地址为 `https://<username>.github.io`。
    - **项目站点**：仓库名可以是任意名称（例如 `418blog`），访问地址为 `https://<username>.github.io/<repo>`。
在GitHub上新建一个名为418blog的仓库，确保Pages有关的设置正确。
![Github设置pages.png](/images/Github设置pages.png)

回到云服务器，在管理员模式下设置用户名和邮箱地址：
```bash
sudo passwd  
# 然后会提示你输入新的UNIX密码，密码设置ok以后，我们进入管理员模式。输入：  
su
```

安装git：
```bash
apt install git
```

配置git：
```bash
git config --global user.name "username"  
git config --global user.email "username@example.com"  
# 检查电脑是否已经有 SSH keys  
ssh-keygen -t rsa -C youremail@example.com  
# -C后面加你在github的用户名邮箱，这样公钥才会被github认可  
less ~/.ssh/id_rsa.pub  
# 查看公钥内容稍后加入Github账户的sshkey中
```

大概显示如下，按q退出。
```text
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCkCIY3F5wQ2SaJU6a8AzKwxnlM4vkarK2R8uYvgunEZyx6rXUBTPXgry9Vtq+rOSZ+wowG1Gpkte4DKeQV0RHQeVbhW5daHt4INjTCopSCpLA7g1ToZ0VD3A7VphFuioj/SnpAkUY7ZZYr1X8+iU989oMHazrRqs5Ji1QAFlVKhJ0LTALMqDpj6EpQRSNzLriDnBp27sFHSrVkNMEguIAe+7/Mpiew6v1v/yIdIxsci+q5du+Yka8nviSgPH/6FJo1SCp+RITkIvV/M+nrmawEP9KqP0koiRJa1SuXmsBxHpeJMKW8U+eySYqNJJsotoEjluRFnnCz7U03Vh6oe0uwjZf5c//aephrJduZxR9Y8OzomXqSwngTBh21AEPpIyksSFV7GKYQ9NG7/EmZS4E1VTsrZoe/wQKSnsmkZqtgqSLKY0JY1i0T1ogPg6ApmEZKtKVcBcJSqrJCqcyY9tzN4vcBnz7E4dKeFscgPNOh6tZCPDvGmMy2GREpW5/5H6c= obsever20210103@gmail.com
/root/.ssh/id_rsa.pub (END)
```

添加到GitHub账户的SSH keys中：
![GitHub的SSHkey.png](/images/GitHub的SSHkey.png)

测试连接情况，第一次一般是这样的：
```bash
root@VM-8-3-ubuntu:/home/ubuntu/blog# ssh -T git@github.com
The authenticity of host 'github.com (20.205.243.166)' can't be established.
ED25519 key fingerprint is SHA256:+DiY3wvvV6TuJJhbpZisF/zLDA0zPMSvHdkr4UvCOqU.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'github.com' (ED25519) to the list of known hosts.
Hi cloak1522! You've successfully authenticated, but GitHub does not provide shell access.
root@VM-8-3-ubuntu:/home/ubuntu/blog# ssh -T git@github.com
Hi cloak1522! You've successfully authenticated, but GitHub does not provide shell access.
```

在Hexo根目录下，有一个`_config.yml`文件，存放了相关配置信息，在其中添加：
```yaml
url: https://cloak1522.github.io/418blog
root: /418blog/

deploy:
  type: git
  repository: git@github.com:cloak1522/418blog.git
  branch: main
```

清理并重新部署：
```bash
hexo clean && hexo generate && hexo deploy
```

部署完成后，访问(https://cloak1522.github.io/418blog)可查看。

### 主题部署到GitHub

$Last Edited：2025.04.28/20:41$
___

首先使用`npm`安装需要的主题，以`butterfly`为例。在Hexo根目录下，执行：
```bash
npm install hexo-theme-butterfly --save
```

在 `_config.yml` 中指定主题名称（与 npm 包名一致）：
```bash
theme: butterfly
```

此时，如果你的 `themes` 目录为空，但通过 `hexo server` 在本地能看到主题，说明你使用的是 **通过 `npm`安装的主题**（例如 `hexo-theme-landscape`），而非传统的克隆主题仓库方式。这种情况下，主题文件不会直接存放在 `themes` 目录中，而是存储在 `node_modules` 目录下。
因此使用脚本将主题资源复制到静态目录。

在 Hexo 根目录创建 `scripts` 文件夹（如果不存在）：
```bash
mkdir scrips
```

创建脚本文件 `scripts/copy-theme.js`：
```javascript
const fs = require('fs-extra');
const path = require('path');

hexo.on('generateBefore', () => {
  const themeName = hexo.config.theme;
  const sourcePath = path.join(hexo.base_dir, 'node_modules', `hexo-theme-${themeName}`);
  const targetPath = path.join(hexo.base_dir, 'themes', themeName);

  // 检查源路径是否存在
  if (!fs.existsSync(sourcePath)) {
    hexo.log.error(`主题源路径不存在: ${sourcePath}`);
    return;
  }

  // 确保 themes 目录存在
  fs.ensureDirSync(path.join(hexo.base_dir, 'themes'));

  // 清空目标目录（确保无残留冲突）
  if (fs.existsSync(targetPath)) {
    fs.removeSync(targetPath);
  }

  // 复制主题文件（含 source 资源）
  try {
    fs.copySync(sourcePath, targetPath, {
      overwrite: true,
      filter: (src, dest) => {
        // 排除嵌套的 node_modules，但允许主题根目录下的文件
        const relativePath = path.relative(sourcePath, src);
        const isNestedNodeModules = relativePath.includes('node_modules') && relativePath !== 'node_modules';
        return !isNestedNodeModules;
      }
    });
	 
    // 验证复制是否成功
    if (fs.existsSync(targetPath)) {
      const files = fs.readdirSync(targetPath);
      hexo.log.info(`主题 ${themeName} 已成功复制到 themes 目录，包含 ${files.length} 个文件/目录`);
    } else {
      hexo.log.error(`主题复制失败：目标目录不存在`);
    }
  } catch (err) {
    hexo.log.error(`复制主题失败: ${err.message}`);
    hexo.log.error(`源路径: ${sourcePath}`);
    hexo.log.error(`目标路径: ${targetPath}`);
  }
});
```
- [x] 脚本文件的详细解释
	1. **依赖导入**
	```javascript
	const fs = require('fs-extra');
	const path = require('path');
	```
	- `fs-extra`: 增强版的文件系统操作库，提供了更多便利的文件操作方法
	- `path`: Node.js 内置的路径处理模块
	
	2. **事件监听器**
	```javascript
	hexo.on('generateBefore', () => {
	```
	- 监听 Hexo 的 `generateBefore` 事件
	- 这个事件在 Hexo 开始生成静态文件之前触发
	- 确保主题文件在生成过程开始前就已经准备好
	
	3. **路径配置**
	```javascript
	const themeName = hexo.config.theme;
	const sourcePath = path.join(hexo.base_dir, 'node_modules', `hexo-theme-${themeName}`);
	const targetPath = path.join(hexo.base_dir, 'themes', themeName);
	```
	- `themeName`: 从 Hexo 配置中获取当前使用的主题名称
	- `sourcePath`: 主题在 `node_modules` 中的位置
	- `targetPath`: 主题应该复制到的目标位置
	
	4. **源路径验证**
	```javascript
	if (!fs.existsSync(sourcePath)) {
	  hexo.log.error(`主题源路径不存在: ${sourcePath}`);
	  return;
	}
	```
	- 检查主题是否真的存在于 `node_modules` 中
	- 如果不存在，记录错误并退出
	
	5. **目录准备**
	```javascript
	fs.ensureDirSync(path.join(hexo.base_dir, 'themes'));
	
	if (fs.existsSync(targetPath)) {
	  fs.removeSync(targetPath);
	}
	```
	- 确保 `themes` 目录存在
	- 如果目标路径已存在，先删除以避免冲突
	
	6. **主题文件复制**
	```javascript
	fs.copySync(sourcePath, targetPath, {
	  overwrite: true,
	  filter: (src, dest) => {
	    const relativePath = path.relative(sourcePath, src);
	    const isNestedNodeModules = relativePath.includes('node_modules') && relativePath !== 'node_modules';
	    return !isNestedNodeModules;
	  }
	});
	```
	**复制选项说明：**
	- `overwrite: true`: 允许覆盖已存在的文件
	- `filter`: 过滤函数，控制哪些文件被复制
	
	**过滤逻辑：**
	- 排除嵌套的 `node_modules` 目录
	- 允许主题根目录下的所有其他文件和目录
	- 这避免了复制不必要的依赖文件
	
	7. **复制结果验证**
	```javascript
	if (fs.existsSync(targetPath)) {
	  const files = fs.readdirSync(targetPath);
	  hexo.log.info(`主题 ${themeName} 已成功复制到 themes 目录，包含 ${files.length} 个文件/目录`);
	} else {
	  hexo.log.error(`主题复制失败：目标目录不存在`);
	}
	```
	- 验证复制是否成功
	- 统计复制的文件数量
	- 提供详细的日志信息
	
	8. **错误处理**
	```javascript
	catch (err) {
	  hexo.log.error(`复制主题失败: ${err.message}`);
	  hexo.log.error(`源路径: ${sourcePath}`);
	  hexo.log.error(`目标路径: ${targetPath}`);
	}
	```
	- 捕获并记录复制过程中的任何错误
	- 提供详细的错误信息和路径信息，便于调试

安装依赖包：
```bash
npm install fs-extra --save
```

重新生成静态文件：
```bash
hexo clean && hexo generate
```

检查`theme`目录：
```bash
ls themes/butterfly
```

输出如下：
```bash
root@VM-8-3-ubuntu:/home/ubuntu/blog# ls themes/butterfly
_config.yml  layout   package.json  README_CN.md  scripts
languages    LICENSE  plugins.yml   README.md     source
```

此时再部署到Github，应该可以看到主题：
```bash
hexo deploy
```

### Hexo目录的权限

$Last Edited：2025.04.28/20:42$
___

Git 默认会检查仓库目录的所有权，如果目录所有者与当前用户不一致（常见于跨用户操作或 `sudo` 误用），会触发 `dubious ownership` 错误。
以下以`.deploy_git`文件夹为例，其他情况也同理。

推荐的做法是将目录加入Git的全局安全列表：
```bash
git config --global --add safe.directory /home/ubuntu/blog/.deploy_git
```

还可以改变目录的所有者，并赋予权限。检查目录所有者用`ls -ld`指令。首先创建一个用户组：
```bash
sudo groupadd hexo_group
```

将 ubuntu 用户和 root 用户加入该用户组：
```bash
sudo usermod -aG hexo_group ubuntu
sudo usermod -aG hexo_group root
```

更改目录的所属组：
```bash
sudo chown -R ubuntu:hexo_group /home/ubuntu/blog/.deploy_git
```

设置目录和文件的权限：
```bash
sudo chmod -R 775 /home/ubuntu/blog/.deploy_git
sudo chmod -R g+rwX /home/ubuntu/blog/.deploy_git
```
- [x] 指令的具体解释：
	==sudo chown -R ubuntu:hexo_group /home/ubuntu/blog/.deploy_git==
	- **`chown`**：是 "change owner" 的缩写，用于更改文件或目录的所有者和所属组。
	- **`-R`**：是递归选项（recursive），表示命令会递归地应用于指定目录及其所有子目录和文件。这意味着不仅会更改 `/home/ubuntu/blog/.deploy_git` 目录的所有者和所属组，还会更改该目录下所有文件和子目录的所有者和所属组。
	-  **`ubuntu:hexo_group`**：
    - `ubuntu` 是新所有者的用户名。
    - `hexo_group` 是新所属组的组名。
    - 这部分指定了新的所有者和所属组。格式为 `用户:组`。
	 
	==sudo chmod -R 775 /home/ubuntu/blog/.deploy_git==
	- **`chmod`**：用于更改文件或目录的权限。
	- **`-R`**：递归选项，表示命令会递归地应用于指定目录及其所有子目录和文件。
	- **`775`**：是一个八进制数字，表示权限设置。具体含义如下
	    - **`7`**：表示所有者（owner）的权限，`7` 对应于 `rwx`（读、写、执行）。
	    - **`7`**：表示所属组（group）的权限，`7` 对应于 `rwx`（读、写、执行）。
	    - **`5`**：表示其他用户（others）的权限，`5` 对应于 `r-x`（读、执行，但没有写权限）。
	因此，`sudo chmod -R 775 /home/ubuntu/blog/.deploy_git` 的作用是
	- 所有者（通常是 `ubuntu` 用户）对目录及其内容有读、写和执行权限。
	- 所属组的用户对目录及其内容有读、写和执行权限。
	- 其他用户对目录及其内容有读和执行权限，但没有写权限。
	
	==sudo chmod -R g+rwX /home/ubuntu/blog/.deploy_git==
	- **`chmod`**：用于更改文件或目录的权限。
	- **`-R`**：递归选项，表示命令会递归地应用于指定目录及其所有子目录和文件。
	- **`g+rwX`**：表示为所属组（group）添加读（`r`）、写（`w`）和执行（`X`）权限。
	因此，`sudo chmod -R g+rwX /home/ubuntu/blog/.deploy_git` 的作用是
	- 为所属组的用户添加读、写和执行权限。
	- 其他用户的权限保持不变。

### 使用Nginx部署Hexo博客

$Last Edited：2025.04.29/17:33$
___
配置防火墙，允许相关端口。可以在服务器安全组设置。
```bash
sudo ufw allow 'Nginx Full'  # 允许 HTTP (80) 和 HTTPS (443)
sudo ufw reload
```

安装Nginx
```bash
sudo apt update
sudo apt install nginx -y
```

创建 Nginx 配置文件
```bash
sudo nano /etc/nginx/sites-available/hexo-blog
```

添加以下内容（根据需求调整）
```nginx                              
server {
    listen 80;
    server_name 154.8.222.175;  # 替换为你的域名或服务器 IP
    root /home/ubuntu/blog/public;  # 指向 Hexo 生成的静态文件目录
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    # 可选：启用 Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml appl>
}
```

启用配置并禁用默认站点
```bash
sudo ln -s /etc/nginx/sites-available/hexo-blog /etc/nginx/sites-enabled
sudo rm /etc/nginx/sites-enabled/default
```

参考[静态博客—Hexo#主题部署到GitHub](静态博客—Hexo#主题部署到GitHub)中的配置，小修了一下脚本文件`scripts/copy-theme.js`如下（直接用上面的应该也可以）：
```yaml
const fs = require('fs-extra');
const path = require('path');

hexo.on('generateBefore', () => {
  const themeName = hexo.config.theme;
  const sourcePath = path.join(hexo.base_dir, 'node_modules', `hexo-theme-${themeNa>
  const targetPath = path.join(hexo.base_dir, 'themes', themeName);

  // 清空目标目录（确保无残留冲突）
  if (fs.existsSync(targetPath)) {
    fs.removeSync(targetPath);
  }

  // 复制主题文件（含 source 资源）
  try {
    fs.copySync(sourcePath, targetPath, {
      overwrite: true,
      filter: (src) => !src.includes('node_modules')  // 排除嵌套 node_modules
    });
    hexo.log.info(`主题 ${themeName} 已复制到 themes 目录`);
  } catch (err) {
    hexo.log.error(`复制主题失败: ${err}`);
  }
});
```

打开Hexo根目录下`_config.yml`文件，检查url的配置，不设置或者如下设置都可以。*如果设置成其他不一致的url，在生成静态文件并访问相应地址时可能无法看到主题。*
```yaml
url: http://154.8.222.175  # 使用服务器 IP 或域名
root: /
```

重新生成静态文件：
```bash
hexo clean && hexo generate
```

确保`public`文件目录可以被`Nginx`读取，模拟`Nginx`访问测试
```bash
# 切换到 www-data 用户尝试访问目录
sudo -u www-data ls -l /home/ubuntu/blog/public
# 应能正常列出文件，无权限错误
```
如果输出`ls: cannot access '/home/ubuntu/blog/public': Permission denied`就要修复`Nginx`访问的权限

- [x] 权限修复过程——从根目录到目标路径的 **每一级目录** 都必须对 `www-data` 用户开放执行权限（`x`）。*（所以博客根目录放在用户目录外是不是好点？）*

	- 让`www-data`用户加入到`hexo_group`组中
	```bash
	sudo usermod -aG hexo_group www-data
	# 检查组内成员
	getent group hexo_group
	```

	- 更改public目录的归属
	```bash
	sudo chown -R ubuntu:hexo_group /home/ubuntu/blog/public
	```
	
	- 修复权限（允许组和其他用户进入），哪一级目录不通给哪一级。
	```bash
	sudo chmod 755 /home/ubuntu
	```
	正确输出应该是：`drwxr-xr-x 11 ubuntu ubuntu 4096 Apr 29 11:21 /home/ubuntu`
	
	逐级检查能否访问。
	```bash
	sudo -u www-data ls /home/ubuntu
	sudo -u www-data ls /home/ubuntu/blog/public
	sudo -u www-data ls /home/ubuntu/blog
	```
	正确的话就会列出文件目录列表。

测试并重启 Nginx
```bash
sudo nginx -t          # 检查语法
sudo systemctl restart nginx
```
在浏览器中输入[服务器域名或IP](http://154.8.222.175/)查看部署情况。

报错可以查看日志
```bash
# 错误日志
sudo tail -f /var/log/nginx/error.log

# 访问日志
sudo tail -f /var/log/nginx/access.log
```

每次更新博客后，执行以下命令：
```bash
cd /home/ubuntu/blog
hexo clean && hexo generate
sudo systemctl restart nginx
```