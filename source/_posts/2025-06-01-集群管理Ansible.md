---
title: 集群管理——Ansible
date: 2025-06-01 10:34:58
updated: 2025-08-12 12:30:12
categories:
  - [服务器&嵌入式平台操作, 工具]
tags:
permalink: 集群管理——ansible/
---

> [!NOTE] 操作环境
> 同一局域网下的多台香橙派4-lts Orange Pi 3.0.6 Bullseye with Linux 5.10.160-rk3399
> ip地址为192.168.0.110-192.168.0.113

## 安装和使用
建议重新查阅官方文档安装，可能会有更新[Ansible 文档 — Ansible 社区文档](https://docs.ansible.org.cn/ansible/latest/index.html)
主要步骤就是
1. 安装Ansible
2. 配置免密登录
3. 指定inventory中的主机，运行写好的playbook
```bash
ansible-playbook -i ./inventory/host.ini ./playbooks/miniconda-install.yml
```

## 问题整理
### 1. 配置SSH免密登录
注意最好保持集群主机的用户统一，之前root用户和orangepi用户混着用，后面想改SSH免密登录的时候出了一系列问题。
详见[SSH#SSH免密登录](SSH#SSH免密登录)
### 2. 由于缺乏sudo密码造成的权限问题
在目标主机（`pi2`）上配置免密 `sudo`，这样 Ansible 可以无需密码执行 `sudo` 命令。

1. 登录到 `pi2`：
```bash
ssh orangepi@192.168.0.111
```

2. 编辑 `sudoers` 文件：
```bash
sudo visudo
```

3. 添加以下内容，允许 `orangepi` 用户免密使用 `sudo`：
```text
orangepi ALL=(ALL) NOPASSWD: ALL
```

4. 保存并退出，运行以下命令，如果不需要输入密码说明配置成功。
```bash
sudo ls
```

### 3. Ansible 用 非登录、非交互 的 `/bin/sh`导致的问题
#### 1.`conda -V`显示`command not found`

$Last Edited：2025.08.12/12:01$
___

正常的conda init完成后，初始化块会被写入到`./bashrc`中，这个指令可以查看
```bash
tail -n 20 ~orangepi/.bashrc
```
 conda 初始化块（以 `# >>> conda initialize >>>` 开头），如果看不到说明没有初始化
 初始化成功之后`conda -V`才是可用的

 本来的想法是通过`conda -V`判断一下是否初始化，如果没有的话就执行初始化流程，但是尝试了很多中方法都没办法正确输出，比如下面这个：
 ```yaml
 ---
- hosts: pi
  remote_user: orangepi
  become: yes
  tasks:
    - name: 检查 Conda 是否可用
      shell: |
        set -e
        source ~/.bashrc
        conda --version
      args:
        executable: /bin/bash
        chdir: /home/orangepi
      become_user: orangepi
      register: conda_check
      ignore_errors: yes
```

会出现错误⬇如果source语句前加个bash -l，则会卡住。
```
fatal: [pi2]: FAILED! => {"changed": true, "cmd": "set -e\nsource ~/.bashrc\nconda --version\n", "delta": "0:00:00.030028", "end": "2025-08-12 03:34:32.224542", "msg": "non-zero return code", "rc": 127, "start": "2025-08-12 03:34:32.194514", "stderr": "/bin/bash: line 3: conda: command not found", "stderr_lines": ["/bin/bash: line 3: conda: command not found"], "stdout": "", "stdout_lines": []}
...ignoring
```

但是pi1却没有报错，只显示changed，这个是AI分析的结果：
pi1 的结果与其他节点不同，主要原因是 pi1 上通过 VS Code 远程连接或运行 VS Code Server，导致 Conda 环境被正确初始化，而其他节点没有类似的初始化过程。
具体分析如下：
1. **PATH 环境变量差异**：
 - pi1 的 PATH 包含 `/opt/miniconda/condabin`，使得 `conda` 命令可以直接找到。
 - 其他节点的 PATH 不包含这个路径，因此无法找到 `conda` 命令。
2. **Conda 相关环境变量**：
 - pi1 上存在 Conda 相关的环境变量（如 `CONDA_EXE`、`CONDA_PYTHON_EXE`），而其他节点没有。
3. **VS Code 环境**
 - pi1 上有许多 VS Code 相关的环境变量，表明它可能通过 VS Code 远程连接或正在运行 VS Code Server。
 - VS Code 在启动时可能会初始化 Conda 环境并设置相关环境变量。
解决方案： 为了使所有节点行为一致，可以采取以下措施之一：
1. 在所有节点上统一配置 Conda 环境，例如通过在 `/etc/profile.d/` 中添加 Conda 初始化脚本。
2. 确保所有节点都通过相同的方式（如 VS Code 远程连接）来访问 Conda 环境。
3. 修改 Ansible playbook，在执行任务前显式初始化 Conda 环境，例如通过 `source /opt/miniconda/etc/profile.d/conda.sh`。

 后面选择通过检查conda hook的相关文本来判断是否初始化：
```yaml
  - name: 检测 ~/.bashrc 是否已包含 conda hook
	shell: |
	  grep -qF '# >>> conda initialize >>>' /home/orangepi/.bashrc
	args:
	  executable: /bin/bash
	register: hook_exists
	become_user: orangepi
	ignore_errors: yes
	changed_when: false
```

不过在写这个笔记时，发现下面这种检查方式好像也可以用：
 ```yaml
 ---
- hosts: pi
  remote_user: orangepi
  become: yes
  tasks:
    - name: 检查 Conda 是否可用
      shell: |
        bash -ilc 'conda --version'
      args:
        executable: /bin/bash
        chdir: /home/orangepi
      become_user: orangepi
      register: conda_check
      ignore_errors: yes
```
1. **`-i`** (interactive)
    - 启动**交互式 shell**
    - 会加载用户的配置文件（如 `~/.bashrc`）
    - 启用交互功能（如命令补全、别名等）
2. **`-l`** (login)
    - 模拟**登录 shell**
    - 会加载登录配置文件（如 `/etc/profile`, `~/.bash_profile`）
    - 设置完整的用户环境变量
3. **`-c`** (command)
    - 执行指定的命令字符串（后面引号中的内容）
    - 执行后立即退出 shell