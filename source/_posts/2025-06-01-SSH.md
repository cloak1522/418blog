---
title: SSH
date: 2025-06-01 10:34:58
updated: 2025-05-31 11:09:06
categories:
  - [服务器&嵌入式平台操作, 基础配置]
tags:
permalink: ssh/
---

## SSH免密登录
参考：[Linux多台机器之间的免密登录设置 - 指尖下的世界 - 博客园](https://www.cnblogs.com/luzhanshi/p/13369797.html)

1. 可以先做一个`主机ip与名称的映射`，方便管理。
```bash
vim /etc/hosts
```

在文件内写入：
```text
192.168.0.110 pi1
192.168.0.111 pi2
192.168.0.112 pi3
192.168.0.113 pi4
```

2. 生成公钥
```bash
ssh-keygen -t rsa
```

3. 将公钥复制到所有需要免密登录的目标主机上
```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub user@hostname
```
- `-i` 指定公钥文件的路径。
- `user@hostname` 是目标主机的用户名和主机名
比如在pi4上运行上述指令，目标主机为pi3，运行成功后目标主机会出现文件
==/root/.ssh/authorized_keys==，完成后可以从pi4上登录pi3。

4. 测试
```bash
ssh hostname date
```
不需要输入密码即成功

如：
```text
root@pi4:~# ssh pi3 date
Sun 22 Dec 2024 03:08:44 PM UTC
```

## 变更SSH密钥的方法
### **Q**：
实现pi2主机的ssh免密登录之后，更改pi2主机的系统镜像，再次复制密钥时出现以下问题。如何解决？ 
```bash
root@orangepi4-lts:~# ssh-copy-id -i ~/.ssh/id_rsa.pub root@pi2 /usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub" /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed /usr/bin/ssh-copy-id: ERROR: @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ ERROR: @ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @ ERROR: @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ ERROR: IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY! ERROR: Someone could be eavesdropping on you right now (man-in-the-middle attack)! ERROR: It is also possible that a host key has just been changed. ERROR: The fingerprint for the ECDSA key sent by the remote host is ERROR: SHA256:KnYcisA4EXVw70Qj4A36IC2/OESREd9X4NsgLxfjmMY. ERROR: Please contact your system administrator. ERROR: Add correct host key in /root/.ssh/known_hosts to get rid of this message. ERROR: Offending ECDSA key in /root/.ssh/known_hosts:2 ERROR: remove with: ERROR: ssh-keygen -f "/root/.ssh/known_hosts" -R "pi2" ERROR: ECDSA host key for pi2 has changed and you have requested strict checking. ERROR: Host key verification failed.
```
### **DeepSeek**：
出现该错误是因为更换系统镜像后，pi2 主机的 SSH 密钥发生了变化，而本地保存的旧密钥记录与新的不匹配。以下是解决方法：

==解决方案分步说明：==

1. **清除旧的密钥记录**
```bash
ssh-keygen -f "/root/.ssh/known_hosts" -R "pi2"
```
   这会从 `known_hosts` 文件中删除所有与 `pi2` 关联的旧密钥记录。

2. **重新尝试复制公钥**
```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub root@pi2
```
系统会提示你确认新主机的指纹（类似 `Are you sure you want to continue connecting (yes/no/[fingerprint])?`），输入 `yes` 并回车。

3. **验证免密登录**
```bash
ssh root@pi2
```
此时应该能无需密码直接登录。

==关键原因：==

- **主机密钥变更**：重装系统会生成新的 SSH 主机密钥，导致本地记录的旧密钥失效。
- **SSH 安全机制**：SSH 默认会检查主机密钥，防止中间人攻击，因此需要手动确认新密钥。

==扩展建议：==

- **持久化主机密钥**：如果频繁重装系统，可备份 `/etc/ssh/ssh_host_*` 密钥文件，重装后恢复以避免此问题。
- **使用固定IP或域名**：确保 `pi2` 的解析地址稳定，避免因IP变化导致密钥关联错误。

### **Q**：
弹出一系列警告，解释一下：
```bash
root@orangepi4-lts:~# ssh-copy-id -i ~/.ssh/id_rsa.pub root@pi2 /usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub" The authenticity of host 'pi2 (192.168.0.111)' can't be established. ECDSA key fingerprint is SHA256:KnYcisA4EXVw70Qj4A36IC2/OESREd9X4NsgLxfjmMY. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: the ECDSA host key for 'pi2' differs from the key for the IP address '192.168.0.111' Offending key for IP in /root/.ssh/known_hosts:2 Are you sure you want to continue connecting (yes/no)? yes /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed Warning: the ECDSA host key for 'pi2' differs from the key for the IP address '192.168.0.111' Offending key for IP in /root/.ssh/known_hosts:2 Matching host key in /root/.ssh/known_hosts:6 Are you sure you want to continue connecting (yes/no)? yes /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys Warning: the ECDSA host key for 'pi2' differs from the key for the IP address '192.168.0.111' Offending key for IP in /root/.ssh/known_hosts:2 Matching host key in /root/.ssh/known_hosts:6 Are you sure you want to continue connecting (yes/no)? yes
```

### **DeepSeek**：
==问题解释：==
你遇到的警告是 **SSH 双重验证冲突**导致的，具体原因如下：

1. **主机密钥与IP密钥不匹配**
- 你之前可能通过 **IP地址（192.168.0.111）** 连接过这台主机，而此次通过 **主机名（pi2）** 连接。
- 系统在 `known_hosts` 文件中记录了 **两种身份标识**（主机名 `pi2` 和 IP 地址 `192.168.0.111`），但两者的密钥因系统镜像更换而不再匹配。

2. **`known_hosts` 文件中的冲突条目**
- 警告中提到的 `Offending key for IP in /root/.ssh/known_hosts:2` 表示第 2 行是 IP 地址的旧密钥。
- `Matching host key in /root/.ssh/known_hosts:6` 表示第 6 行是主机名 `pi2` 的新密钥。
- SSH 发现同一个 IP 对应的密钥在不同记录中不一致，触发安全警告。

==解决方案：==
彻底清除 `pi2` 相关的所有旧密钥记录，步骤如下：

1. **删除主机名和IP的旧记录**
```bash
ssh-keygen -f ~/.ssh/known_hosts -R "pi2"          # 删除主机名记录
ssh-keygen -f ~/.ssh/known_hosts -R "192.168.0.111" # 删除IP地址记录
```

2. **重新执行 `ssh-copy-id`**
```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub root@pi2
```
当提示 `Are you sure you want to continue connecting (yes/no)?` 时，输入 `yes`

3. **验证连接**
```bash
ssh root@pi2
```
此时应直接登录，不再出现警告。

==根本原因总结：==

| 现象                 | 原因                              | 解决方案     |
| ------------------ | ------------------------------- | -------- |
| `Host key differs` | 主机名和IP在 `known_hosts` 中记录了不同的密钥 | 清除所有相关条目 |
| 多次确认提示             | SSH 检测到新旧密钥交替冲突                 | 统一密钥记录   |

## `rm -rf ~/.ssh/*` 清除配置后恢复
$Last Edited：2025.05.31/11:09$
___

1. 重建 ~/.ssh 目录（确保权限正确）
```bash
mkdir -p ~/.ssh              # 如果目录不存在，则创建 
chmod 700 ~/.ssh             # SSH要求目录权限必须是 700
```

2. 重新生成 SSH 密钥对

```bash
ssh-keygen -t ed25519 -f ~/.ssh/id_rsa  # 更推荐 ed25519 算法（比 RSA 更安全）
```

（或继续用 RSA 算法）
```bash
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa
```
-t ed25519：更安全、更快的密钥类型（推荐）。
-b 4096：如果是 RSA，设置更强的密钥长度（默认 3072）。
➡ 按 Enter 直接跳过密码（SSH 密钥对密码是可选的）

3. 修复文件权限
```bash
chmod 600 ~/.ssh/id_rsa       # 私钥必须 600（仅自己可读写） 
chmod 644 ~/.ssh/id_rsa.pub   # 公钥可以 644（自己可读写，其他人可读）
```

✅ 验证权限是否正确：
```bash
ls -la ~/.ssh/
```

正确输出示例：
```text
-rw------- 1 orangepi orangepi 2602 May 31 12:34 id_rsa      # 600 
-rw-r--r-- 1 orangepi orangepi  572 May 31 12:34 id_rsa.pub  # 644
```

4. 重新部署公钥到目标服务器（如 pi2）
```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub orangepi@pi2
```

✋ 如果 ssh-copy-id 无法使用（需要输入密码），可以手动：

```bash
cat ~/.ssh/id_rsa.pub | ssh orangepi@pi2 "mkdir -p ~/.ssh; chmod 700 ~/.ssh; cat >> ~/.ssh/authorized_keys; chmod 600 ~/.ssh/authorized_keys"
```

5. 测试 SSH 免密登录
```bash
ssh orangepi@pi2
```
✅ 如果成功，说明修复完成！