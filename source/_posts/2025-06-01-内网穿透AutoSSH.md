---
title: 内网穿透—AutoSSH
date: 2025-06-01 10:34:58
updated: 2025-04-20 17:27:53
categories:
  - [服务器&嵌入式平台操作, 工具]
tags:
permalink: 内网穿透—autossh/
---

$Last Edited：2025.04.20/17:25$
___

参考：[利用AutoSSH建立SSH隧道，实现内网穿透 - 知乎](https://zhuanlan.zhihu.com/p/112227542)
[autossh 配置开机启动_autossh开机自启-CSDN博客](https://blog.csdn.net/matrix273/article/details/104058716)
[SSH隧道详解与使用AutoSSH实现稳定的内网穿透_autossh实现内网穿透-CSDN博客](https://blog.csdn.net/yao51011010/article/details/137122354)
### 1.前期配置
#### 免密登录
​SSH反向链接会因为超时而关闭，如果关闭了那从外网连通内网的通道就无法维持，为此我们需要结合免密码登录及 AutoSSH 来提供稳定的 SSH 反向代理隧道。

​ 在内网主机上产生公钥和私钥
```bash
ssh-keygen
```
然后按三次回车执行默认选项生成公钥和私钥。会生成密钥文件和私钥文件 id_rsa,id_rsa.pub 或 id_dsa,id_dsa.pub

​拷贝秘钥 在内网主机上继续执行如下命令，将内网主机上的秘钥文件 copy 到云服务器中。
```bash
ssh-copy-id  username@ip
```
其中“username”是云服务器的用户名，ip 为云服务器的 ip，然后按照提示输入云服务器的密码就完成了。

#### 修改SSH配置文件
修改云服务器的 SSH 配置文件`/etc/ssh/sshd_config`
```text
GatewayPorts yes
```
​ 这样可以把监听的端口绑定到任意 IP 0.0.0.0 上，否则只有本机 127.0.0.1 可以访问。

​ 重启SSHD服务
```bash
sudo service sshd restart
```

#### 云服务器开放端口
将云服务器用于转发的端口放通，在安全组设置中，只放通入方向的就可以，协议为TCP。

### 2. 安装与使用`autossh`
在内网主机中安装。
在大多数Linux发行版中，可以通过包管理器安装`autossh`：
```bash
sudo apt-get install autossh  # Debian/Ubuntu
sudo yum install autossh      # CentOS
```

在内网主机 A上，利用 `autossh`建立一条 SSH 隧道
```bash
autossh -M 4010 -NR 80:localhost:4000 [用户名]@[服务器ip] (-p xxxx)
```
​
检查端口情况：
```bash
lsof -i:4010
```

**参数解释：**
- “-M 4010”意思是使用内网主机 A 的 4010 端口监视 SSH 连接状态，连接出问题了会自动重连
- “ -N”意思是不执行远程命令
- “-R”意思是将远程主机（公网主机 B）的某个端口转发到本地指定机器的指定端口

​ **代码解释：**
- “80:localhost:4000”意思是将内网主机 A 的 4000 号端口转发至公网主机 B 的 80 号端口上  
- “-p xxxx”意思是公网主机 B 的 SSH 端口，如果是默认的 22 号端口，则可以不输入

### 3. 使用`systemd`自启动服务

创建一个`systemd`服务文件，例如`autossh-tunnel.service`：
```bash
sudo nano /etc/systemd/system/autossh-tunnel.service
```

在文件中添加以下内容：
```ini
[Unit]
Description=Autossh Reverse Tunnel Service
After=network.target

[Service]
Type=simple
User=orangepi
Group=orangepi
Environment="AUTOSSH_GATETIME=0"
ExecStart=/usr/bin/autossh -M [监视端口] -N -R [远程端口]:localhost:22 -i /home/orangepi/.ssh/id_rsa [用户名]@[服务器ip]
Restart=on-failure

[Install]
WantedBy=multi-user.target
```
其中22端口为SSH登录的端口。

启用并启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable autossh-tunnel.service
sudo systemctl start autossh-tunnel.service
```